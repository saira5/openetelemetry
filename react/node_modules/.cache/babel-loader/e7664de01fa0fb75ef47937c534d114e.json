{"ast":null,"code":"/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) {\n        if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n      }\n    };\n\n    return _extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n\n    _extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nimport { CollectorExporterBase } from '../../CollectorExporterBase';\nimport { parseHeaders } from '../../util';\nimport { sendWithBeacon, sendWithXhr } from './util';\nimport { diag } from '@opentelemetry/api';\nimport { getEnv, baggageUtils } from '@opentelemetry/core';\n/**\n * Collector Metric Exporter abstract base class\n */\n\nvar CollectorExporterBrowserBase =\n/** @class */\nfunction (_super) {\n  __extends(CollectorExporterBrowserBase, _super);\n  /**\n   * @param config\n   */\n\n\n  function CollectorExporterBrowserBase(config) {\n    if (config === void 0) {\n      config = {};\n    }\n\n    var _this = _super.call(this, config) || this;\n\n    _this._useXHR = false;\n    _this._useXHR = !!config.headers || typeof navigator.sendBeacon !== 'function';\n\n    if (_this._useXHR) {\n      _this._headers = Object.assign({}, parseHeaders(config.headers), baggageUtils.parseKeyPairsIntoRecord(getEnv().OTEL_EXPORTER_OTLP_HEADERS));\n    } else {\n      _this._headers = {};\n    }\n\n    return _this;\n  }\n\n  CollectorExporterBrowserBase.prototype.onInit = function () {\n    window.addEventListener('unload', this.shutdown);\n  };\n\n  CollectorExporterBrowserBase.prototype.onShutdown = function () {\n    window.removeEventListener('unload', this.shutdown);\n  };\n\n  CollectorExporterBrowserBase.prototype.send = function (items, onSuccess, onError) {\n    var _this = this;\n\n    if (this._isShutdown) {\n      diag.debug('Shutdown already started. Cannot send objects');\n      return;\n    }\n\n    var serviceRequest = this.convert(items);\n    var body = JSON.stringify(serviceRequest);\n    var promise = new Promise(function (resolve, reject) {\n      if (_this._useXHR) {\n        sendWithXhr(body, _this.url, _this._headers, resolve, reject);\n      } else {\n        sendWithBeacon(body, _this.url, {\n          type: 'application/json'\n        }, resolve, reject);\n      }\n    }).then(onSuccess, onError);\n\n    this._sendingPromises.push(promise);\n\n    var popPromise = function popPromise() {\n      var index = _this._sendingPromises.indexOf(promise);\n\n      _this._sendingPromises.splice(index, 1);\n    };\n\n    promise.then(popPromise, popPromise);\n  };\n\n  return CollectorExporterBrowserBase;\n}(CollectorExporterBase);\n\nexport { CollectorExporterBrowserBase };","map":{"version":3,"sources":["../../../../src/platform/browser/CollectorExporterBrowserBase.ts"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;AAcG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEH,SAAS,qBAAT,QAAsC,6BAAtC;AAGA,SAAS,YAAT,QAA6B,YAA7B;AACA,SAAS,cAAT,EAAyB,WAAzB,QAA4C,QAA5C;AACA,SAAS,IAAT,QAAqB,oBAArB;AACA,SAAS,MAAT,EAAiB,YAAjB,QAAqC,qBAArC;AAEA;;AAEG;;AACH,IAAA,4BAAA;AAAA;AAAA,UAAA,MAAA,EAAA;EAGY,SAAA,CAAA,4BAAA,EAAA,MAAA,CAAA;EAQV;;AAEG;;;EACH,SAAA,4BAAA,CAAY,MAAZ,EAAoD;IAAxC,IAAA,MAAA,KAAA,KAAA,CAAA,EAAA;MAAA,MAAA,GAAA,EAAA;IAAwC;;IAApD,IAAA,KAAA,GACE,MAAA,CAAA,IAAA,CAAA,IAAA,EAAM,MAAN,KAAa,IADf;;IALQ,KAAA,CAAA,OAAA,GAAmB,KAAnB;IAON,KAAI,CAAC,OAAL,GACE,CAAC,CAAC,MAAM,CAAC,OAAT,IAAoB,OAAO,SAAS,CAAC,UAAjB,KAAgC,UADtD;;IAEA,IAAI,KAAI,CAAC,OAAT,EAAkB;MAChB,KAAI,CAAC,QAAL,GAAgB,MAAM,CAAC,MAAP,CACd,EADc,EAEd,YAAY,CAAC,MAAM,CAAC,OAAR,CAFE,EAGd,YAAY,CAAC,uBAAb,CACE,MAAM,GAAG,0BADX,CAHc,CAAhB;IAOD,CARD,MAQO;MACL,KAAI,CAAC,QAAL,GAAgB,EAAhB;IACD;;;EACF;;EAED,4BAAA,CAAA,SAAA,CAAA,MAAA,GAAA,YAAA;IACE,MAAM,CAAC,gBAAP,CAAwB,QAAxB,EAAkC,KAAK,QAAvC;EACD,CAFD;;EAIA,4BAAA,CAAA,SAAA,CAAA,UAAA,GAAA,YAAA;IACE,MAAM,CAAC,mBAAP,CAA2B,QAA3B,EAAqC,KAAK,QAA1C;EACD,CAFD;;EAIA,4BAAA,CAAA,SAAA,CAAA,IAAA,GAAA,UACE,KADF,EAEE,SAFF,EAGE,OAHF,EAGiE;IAHjE,IAAA,KAAA,GAAA,IAAA;;IAKE,IAAI,KAAK,WAAT,EAAsB;MACpB,IAAI,CAAC,KAAL,CAAW,+CAAX;MACA;IACD;;IACD,IAAM,cAAc,GAAG,KAAK,OAAL,CAAa,KAAb,CAAvB;IACA,IAAM,IAAI,GAAG,IAAI,CAAC,SAAL,CAAe,cAAf,CAAb;IAEA,IAAM,OAAO,GAAG,IAAI,OAAJ,CAAkB,UAAC,OAAD,EAAU,MAAV,EAAgB;MAChD,IAAI,KAAI,CAAC,OAAT,EAAkB;QAChB,WAAW,CAAC,IAAD,EAAO,KAAI,CAAC,GAAZ,EAAiB,KAAI,CAAC,QAAtB,EAAgC,OAAhC,EAAyC,MAAzC,CAAX;MACD,CAFD,MAEO;QACL,cAAc,CAAC,IAAD,EAAO,KAAI,CAAC,GAAZ,EAAiB;UAAE,IAAI,EAAE;QAAR,CAAjB,EAA+C,OAA/C,EAAwD,MAAxD,CAAd;MACD;IACF,CANe,EAOb,IAPa,CAOR,SAPQ,EAOG,OAPH,CAAhB;;IASA,KAAK,gBAAL,CAAsB,IAAtB,CAA2B,OAA3B;;IACA,IAAM,UAAU,GAAG,SAAb,UAAa,GAAA;MACjB,IAAM,KAAK,GAAG,KAAI,CAAC,gBAAL,CAAsB,OAAtB,CAA8B,OAA9B,CAAd;;MACA,KAAI,CAAC,gBAAL,CAAsB,MAAtB,CAA6B,KAA7B,EAAoC,CAApC;IACD,CAHD;;IAIA,OAAO,CAAC,IAAR,CAAa,UAAb,EAAyB,UAAzB;EACD,CA3BD;;EA4BF,OAAA,4BAAA;AAAC,CAnED,CAGY,qBAHZ,CAAA","sourceRoot":"","sourcesContent":["/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        if (typeof b !== \"function\" && b !== null)\n            throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nimport { CollectorExporterBase } from '../../CollectorExporterBase';\nimport { parseHeaders } from '../../util';\nimport { sendWithBeacon, sendWithXhr } from './util';\nimport { diag } from '@opentelemetry/api';\nimport { getEnv, baggageUtils } from '@opentelemetry/core';\n/**\n * Collector Metric Exporter abstract base class\n */\nvar CollectorExporterBrowserBase = /** @class */ (function (_super) {\n    __extends(CollectorExporterBrowserBase, _super);\n    /**\n     * @param config\n     */\n    function CollectorExporterBrowserBase(config) {\n        if (config === void 0) { config = {}; }\n        var _this = _super.call(this, config) || this;\n        _this._useXHR = false;\n        _this._useXHR =\n            !!config.headers || typeof navigator.sendBeacon !== 'function';\n        if (_this._useXHR) {\n            _this._headers = Object.assign({}, parseHeaders(config.headers), baggageUtils.parseKeyPairsIntoRecord(getEnv().OTEL_EXPORTER_OTLP_HEADERS));\n        }\n        else {\n            _this._headers = {};\n        }\n        return _this;\n    }\n    CollectorExporterBrowserBase.prototype.onInit = function () {\n        window.addEventListener('unload', this.shutdown);\n    };\n    CollectorExporterBrowserBase.prototype.onShutdown = function () {\n        window.removeEventListener('unload', this.shutdown);\n    };\n    CollectorExporterBrowserBase.prototype.send = function (items, onSuccess, onError) {\n        var _this = this;\n        if (this._isShutdown) {\n            diag.debug('Shutdown already started. Cannot send objects');\n            return;\n        }\n        var serviceRequest = this.convert(items);\n        var body = JSON.stringify(serviceRequest);\n        var promise = new Promise(function (resolve, reject) {\n            if (_this._useXHR) {\n                sendWithXhr(body, _this.url, _this._headers, resolve, reject);\n            }\n            else {\n                sendWithBeacon(body, _this.url, { type: 'application/json' }, resolve, reject);\n            }\n        })\n            .then(onSuccess, onError);\n        this._sendingPromises.push(promise);\n        var popPromise = function () {\n            var index = _this._sendingPromises.indexOf(promise);\n            _this._sendingPromises.splice(index, 1);\n        };\n        promise.then(popPromise, popPromise);\n    };\n    return CollectorExporterBrowserBase;\n}(CollectorExporterBase));\nexport { CollectorExporterBrowserBase };\n//# sourceMappingURL=CollectorExporterBrowserBase.js.map"]},"metadata":{},"sourceType":"module"}